name: Tag Release

on:
  pull_request:
    types: [closed]
    branches:
      - main

permissions:
  contents: write
  actions: write

jobs:
  tag:
    if: ${{ github.event.pull_request.merged == true && startsWith(github.event.pull_request.head.ref, 'release/v') }}
    runs-on: ubuntu-latest
    steps:
      - name: Create tag and trigger release workflow
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const headRef = pr?.head?.ref;
            const sha = pr?.merge_commit_sha;

            // release branch format: release/vX.Y.Z -> tag: vX.Y.Z
            const tagName = typeof headRef === 'string' ? headRef.replace(/^release\//, '') : '';

            if (!tagName.startsWith('v')) {
              throw new Error(`Unexpected release branch name: ${headRef}`);
            }

            if (!sha) {
              throw new Error('Missing merge_commit_sha for merged PR.');
            }

            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Create tag ref if missing.
            try {
              await github.rest.git.getRef({ owner, repo, ref: `tags/${tagName}` });
              console.log(`Tag ${tagName} already exists; skipping tag creation.`);
              console.log(`If you need to re-run the release, manually dispatch the Release workflow on ref ${tagName}.`);
              return;
            } catch (error) {
              if (error.status !== 404) throw error;
            }

            await github.rest.git.createRef({
              owner,
              repo,
              ref: `refs/tags/${tagName}`,
              sha,
            });

            // Wait for the tag ref to become available before dispatching.
            for (let attempt = 1; attempt <= 8; attempt++) {
              try {
                await github.rest.git.getRef({ owner, repo, ref: `tags/${tagName}` });
                break;
              } catch (error) {
                if (error.status !== 404) throw error;
                await new Promise((r) => setTimeout(r, attempt * 1000));
              }
            }

            // Trigger Release workflow (workflow_dispatch) on the tag ref.
            await github.rest.actions.createWorkflowDispatch({
              owner,
              repo,
              workflow_id: 'release-on-tag.yml',
              ref: tagName,
            });
